# 📚 PubMed論文検索自動化ツール

医学研究における参考文献探しを効率化するツールです。起点となる論文から、PubMedのSimilar ArticlesとCited Byを自動的に辿り、Gemini AIを使って研究テーマとの関連性を評価しながら、関連論文を収集します。

## ✨ 主な機能

### 🔍 検索・探索機能
- **自動探索**: 起点論文から関連論文を再帰的に探索
- **AI評価**: Gemini APIで各論文との関連性を0-100のスコアで評価
- **スマートフィルタリング**: 関連性が低い論文は次階層の探索から除外
- **論文数制限**: 1論文あたりの最大関連論文数を制限可能（探索数の爆発を防止）
- **年代フィルタ**: 特定の年以降の論文のみに絞り込み可能
- **評価停止**: 検索中に途中で停止可能
- **堅牢なエラーハンドリング**:
  - Gemini API TPM制限時の自動リトライ（60秒/120秒/180秒待機）
  - 評価後の即座保存で進捗保護（最大1件のデータ損失に抑制）
  - Notion API タイムアウトへのリトライ処理（30秒/60秒/90秒待機）

### 📊 プロジェクト管理
- **キャッシュ機能**: 評価済み論文を自動保存し、重複評価を防止（API コスト削減）
- **検索の再開・追加**: 既存プロジェクトに新しい起点から論文を追加可能
  - 「この論文を起点に検索」ボタンで、プロジェクト内論文から即座に検索開始
- **論文削除**: 不要な論文や評価失敗した論文を削除して再評価可能
- **検索セッション管理**: 各検索を自動的に記録し、フィルタで絞り込み可能
  - 同日に複数回検索しても、最新の検索で追加された論文のみ表示できる
  - 過去の検索セッションも選択可能（日時と件数を表示）
- **フィルタ＆エクスポート**: 検索なしでプロジェクト内論文をフィルタリング・エクスポート可能
  - 検索セッション、Notion登録状態、スコアで絞り込み
  - 評価日時を論文詳細に表示
- **ソース追跡**: 各論文がどの論文のSimilar/Cited byから発見されたかを記録

### 🎨 UI・UX
- **WebベースGUI**: Streamlitによる使いやすいインターフェース
- **スライダー + 数値入力**: すべてのパラメータで直接数値入力可能（双方向連動）
- **リアルタイムフィルタ**: 検索結果画面でフィルタを変更しても結果が保持される
- **スコア分布表示**: プロジェクト内論文のスコア分布を視覚的に把握
- **API Key管理**: 無効なAPI Keyを検出し、GUIから.envに保存可能
- **JSON出力**: 収集した論文データをJSON形式でエクスポート

### 🔗 外部連携
- **Notion連携**: Notionデータベースとの連携
  - 論文の登録状態を自動チェック
  - 関連性スコアをNotionに自動更新
  - Notionページへ直接リンク
  - Notion未登録論文のみ表示するフィルタ
  - 連携情報の永続化（再読み込み時も反映）
- **京都大学図書館Article Linker**: 各論文からワンクリックでアクセス可能

## 🚀 セットアップ

### 簡単セットアップ（初心者向け）

**CLIに慣れていない方は、こちらの方法を推奨します！**

#### Mac の場合

1. Python 3.8以上をインストール（[ダウンロード](https://www.python.org/downloads/)）
2. `setup.command` をダブルクリック
3. 完了したら `.env` ファイルを開いて Gemini API Key を設定
4. `run.command` をダブルクリックしてアプリ起動

#### Windows の場合

1. Python 3.8以上をインストール（[ダウンロード](https://www.python.org/downloads/)）
   - インストール時に **「Add Python to PATH」にチェック** を入れる
2. `setup.bat` をダブルクリック
3. 完了したら `.env` ファイルを開いて Gemini API Key を設定
4. `run.bat` をダブルクリックしてアプリ起動

### 手動セットアップ（上級者向け）

#### 1. 必要な環境

- Python 3.8以上
- Gemini API Key（無料で取得可能）

#### 2. インストール

```bash
# リポジトリをクローン（または手動でダウンロード）
cd AriticleFinder

# 依存パッケージをインストール
pip install -r requirements.txt
```

#### 3. API Keyの設定

Gemini API Keyを取得してください：
https://makersuite.google.com/app/apikey

方法1: 環境変数に設定（推奨）

```bash
# .envファイルを作成
cp .env.example .env

# .envファイルを編集してAPI Keyを設定
# GEMINI_API_KEY=your_api_key_here
```

方法2: GUIで直接入力

起動後、サイドバーのAPI設定欄にAPI Keyを入力し、「💾 API Keyを.envに保存」ボタンで保存できます

#### 4. Notion連携の設定（オプション）

Notionデータベースと連携する場合：

1. Notion APIキーを取得: https://www.notion.so/my-integrations
2. データベースIDを取得（データベースURLの`workspace/`の後の文字列）
3. `.env`ファイルに追加：
```bash
NOTION_API_KEY=your_notion_api_key_here
NOTION_DATABASE_ID=your_database_id_here
```

または、アプリ起動後にサイドバーの「Notion連携」セクションで設定可能です。

**必要なNotionデータベースのプロパティ**：
- `PubMed`: URL型（論文のPubMed URLを保存）
- `Score`: 数値型（関連性スコアを保存）

## 📖 使い方

### アプリケーションの起動

#### 簡単セットアップを使用した場合

- **Mac**: `run.command` をダブルクリック
- **Windows**: `run.bat` をダブルクリック

ブラウザが自動的に開きます（通常 http://localhost:8501）

#### 手動セットアップを使用した場合

```bash
streamlit run main.py
```

ブラウザが自動的に開きます（通常 http://localhost:8501）

### 2. 設定を入力

#### サイドバー設定

##### API設定
- **Gemini API Key**: API Keyを入力（無効なキーは自動検出）
- **Geminiモデル**: 使用するGeminiモデルを選択（すべて無料枠あり）
  - `gemma-3-27b-it`（デフォルト）: API制限が緩やか、推奨
  - `gemini-2.5-flash-preview-09-2025`: 最新プレビュー版
  - `gemini-2.5-flash`: 最新の安定版高速モデル
  - `gemini-2.5-flash-lite`: 最も高速で低コスト
  - `gemini-2.5-pro`: 最高精度、複雑な推論に最適
  - `gemini-2.0-flash`: 安定版マルチモーダルモデル
  - `gemini-2.0-flash-lite`: 安定版の軽量モデル

##### Notion連携（オプション）
- **Notion連携を有効にする**: チェックでNotion連携機能を有効化
- **Notion API Key**: Notion APIキーを入力
- **Notion Database ID**: NotionデータベースIDを入力
- 検索実行時に自動的に論文の登録状態をチェックし、スコアを更新

##### プロジェクト設定
- **プロジェクト**:
  - 新規プロジェクト作成: 新しいプロジェクトを作成
  - 既存プロジェクトに追加: 既存プロジェクトに論文を追加（重複評価を防止）

##### 探索設定
- **探索の深さ**: 何階層まで関連論文を辿るか（1-5）
  - スライダーまたは数値入力で設定可能
- **最大論文数**: 収集する論文の最大数（10-1000、5刻み）
  - デフォルト: 100
  - スライダーまたは数値入力で設定可能
- **関連性スコア閾値**: この値以上のスコアの論文のみ次階層を探索（0-100、5刻み）
  - スライダーまたは数値入力で設定可能

##### 関連論文取得設定
- **1論文あたりの最大関連論文数**: 各論文から取得するSimilar/Cited byの最大数（5-100、5刻み）
  - デフォルト: 20
  - 探索数の爆発を防ぐための重要な設定

##### フィルタ設定
- **年代フィルタ**: 特定の年以降の論文のみ収集（オプション）
- **探索対象**: Similar articles / Cited by の選択

#### メインエリア

- **起点論文**: PubMed IDまたはURL
  - 例: `12345678` または `https://pubmed.ncbi.nlm.nih.gov/12345678/`
- **探したい論文の内容**: どのような論文を探したいか具体的に記載
  - 例: 「2型糖尿病患者におけるインスリン抵抗性と心血管疾患リスクの関連について研究している論文を探しています。特にメトホルミンやGLP-1受容体作動薬などの治療薬の効果を含めた研究に興味があります。」
  - AIがこの内容に合致する論文を評価して探します

### 3. 検索を開始

「🚀 論文検索を開始」ボタンをクリック

検索中は「⏸️ 評価を停止」ボタンで途中停止も可能です

### 4. 結果の確認

#### 検索結果画面
- **統計情報**: 発見論文数、新規評価数、キャッシュ数、関連論文数、到達階層
- **フィルタ**:
  - 関連論文のみ表示（チェックボックス）
  - Notion未登録のみ表示（チェックボックス）
  - 最小スコア（スライダー + 数値入力、双方向連動）
- **論文リスト**:
  - 各論文の詳細情報（PMID、著者、ジャーナル、出版年）
  - 京都大学図書館Article Linkerへのリンク
  - 関連性スコア、関連あり/なし、探索階層
  - Notion登録状態とNotionページへのリンク
  - 発見元の表示（どの論文のSimilar/Cited byから発見されたか）
  - Abstract全文
  - AI評価理由
- **エクスポート**: 全データ、フィルタ後データ、プロジェクト全体をJSON形式でダウンロード

#### プロジェクト内論文一覧（検索不要）
既存プロジェクトを選択すると、検索せずに論文を確認・管理できます：
- **統計情報**: 総論文数、Notion登録済み数、スコア分布（棒グラフ）
- **Notion連携**: プロジェクト内の全論文をNotionデータベースと照合
- **フィルタ**:
  - 検索セッション（すべて/最新の検索/過去のセッション）
  - Notion未登録のみ表示
  - 最小スコア（スライダー + 数値入力、双方向連動）
- **論文リスト**:
  - 各論文の詳細情報とAbstract全文
  - 評価日時を表示
  - 京都大学図書館Article LinkerとNotionページへのリンク
  - 「この論文を起点に検索」ボタンで即座に検索開始
- **エクスポート**: フィルタ後データ、プロジェクト全体
- **論文管理**: 各論文の削除（削除後、次回検索時に再評価可能）

## 📁 プロジェクト構造

```
AriticleFinder/
├── main.py                 # Streamlit WebGUI
├── article_finder.py       # 論文探索メインロジック
├── pubmed_api.py          # PubMed API連携
├── gemini_evaluator.py    # Gemini AI評価
├── notion_api.py          # Notion API連携
├── project_manager.py     # プロジェクト管理
│
├── setup.command          # Mac用セットアップスクリプト
├── setup.bat              # Windows用セットアップスクリプト
├── run.command            # Mac用起動スクリプト
├── run.bat                # Windows用起動スクリプト
│
├── requirements.txt       # 依存パッケージ
├── .env.example          # 環境変数サンプル
├── .gitignore            # Git除外設定
├── README.md             # このファイル
├── CLAUDE.md             # 開発者向けドキュメント
│
├── example_output.json           # JSON出力サンプル
├── example_project_export.json  # プロジェクトエクスポートサンプル
│
└── projects/             # プロジェクトデータ保存先（自動生成）
    └── project_name/
        ├── metadata.json     # プロジェクト情報
        └── articles.json     # 評価済み論文データ
```

## 🔧 仕組み

1. **起点論文を取得**: PubMed APIから論文情報とアブストラクトを取得
2. **AI評価**: Gemini APIで研究テーマとの関連性を評価
3. **関連論文を取得**: Similar articlesとCited byのリストを取得
4. **再帰的探索**: 関連性が高い論文についてステップ2-3を繰り返す
5. **結果出力**: 収集した論文をスコア順にソートして表示

### PubMed E-utilities API

- **ESummary**: 論文のメタデータ取得
- **EFetch**: アブストラクト取得
- **ELink**: 関連論文・引用論文のリンク取得
- レート制限: 1秒に3リクエストまで（自動調整）

### Gemini API

- **デフォルトモデル**: gemma-3-27b-it（API制限が緩やか）
- **利用可能モデル**: gemma-3-27b-it, gemini-2.5-flash系, gemini-2.0-flash系など
- **評価基準**: ユーザーが探している論文との合致度を0-100でスコアリング
- **評価理由**: スコアの根拠を自然言語で説明
- **キャッシュ**: 一度評価した論文は保存され、再評価を回避してコスト削減

## 📂 プロジェクト機能の詳細

### プロジェクトとは

プロジェクトは、特定の研究テーマに関連する論文をまとめて管理する単位です。プロジェクトを使用することで：

- **重複評価を防止**: 一度評価した論文は自動的にキャッシュされ、再評価されません
- **API コスト削減**: Gemini APIの呼び出し回数を削減し、コストを大幅に節約
- **継続的な探索**: 複数回に分けて論文を追加できる（API制限による中断後の再開も可能）
- **複数起点からの探索**: 異なる起点論文から同じテーマで論文を追加可能

### プロジェクトの作成

1. サイドバーで「新規プロジェクト作成」を選択
2. プロジェクト名を入力（例: 「糖尿病治療研究」）
3. 研究テーマを入力
4. 起点論文を指定して検索開始

プロジェクトデータは `projects/プロジェクト名/` に自動保存されます。

### 既存プロジェクトへの追加

1. サイドバーで「既存プロジェクトに追加」を選択
2. プロジェクト一覧から対象プロジェクトを選択
3. 新しい起点論文を指定（または同じ起点で設定変更）
4. 検索開始

**重要**: 既に評価済みの論文は自動的にスキップされ、新規論文のみが評価されます。

### 関連性閾値の変更

プロジェクトでは、**関連性スコア（0-100）はキャッシュされますが、関連性判定（is_relevant）は現在の閾値で再計算**されます。

#### シナリオ例

1. **最初の検索（閾値80点）**:
   - 65点の論文 → 評価してスコア保存 → is_relevant=False（80点未満）
   - 次階層の探索対象外

2. **2回目の検索（閾値60点に変更）**:
   - 65点の論文 → スコアはキャッシュから取得（API不要） → is_relevant=True（60点以上に再判定）
   - **次階層の探索対象に含まれる！**

この仕組みにより、閾値を調整しながら最適な論文収集が可能です。

- **スコア**: キャッシュから使用（Gemini API不要、コスト削減）
- **関連性判定**: 現在の閾値で再計算（柔軟な探索）

### プロジェクトデータの保存形式

```
projects/
└── プロジェクト名/
    ├── metadata.json      # プロジェクト情報
    │   - name: プロジェクト名
    │   - research_theme: 研究テーマ
    │   - created_at: 作成日時
    │   - updated_at: 更新日時
    │   - stats: 統計情報
    │
    └── articles.json      # 評価済み論文データ
        - PMID ごとに論文情報と評価結果を保存
        - relevance_score: 関連性スコア
        - is_relevant: 関連性あり/なし
        - relevance_reasoning: 評価理由
        - source_pmid: 発見元のPMID
        - source_type: 発見元のタイプ（similar/cited_by/起点論文）
        - depth: 探索階層
        - evaluated_at: 評価日時
```

## 📝 使用例

### 例1: 糖尿病治療の研究

```
起点論文: 35000000
探したい論文: 2型糖尿病患者におけるSGLT2阻害薬の心血管保護効果について研究している論文を探しています。
           特に心不全や腎機能への影響を含めた臨床試験結果に興味があります。
探索深さ: 2
最大論文数: 100
1論文あたりの最大関連論文数: 20
関連性閾値: 60
```

### 例2: がん免疫療法の研究

```
起点論文: https://pubmed.ncbi.nlm.nih.gov/33000000/
探したい論文: 非小細胞肺がんに対する免疫チェックポイント阻害薬の効果について研究している論文を探しています。
           バイオマーカー（PD-L1発現など）との関連を含めた研究に興味があります。
探索深さ: 3
最大論文数: 200
1論文あたりの最大関連論文数: 30
関連性閾値: 70
年代フィルタ: 2020年以降
```

## ⚠️ 注意事項

- **API制限**: Gemini APIには無料枠があります。大量の論文を評価する場合は料金が発生する可能性があります
- **処理時間**: 論文数や探索深さによっては、数分〜数十分かかる場合があります
- **アブストラクト**: アブストラクトが取得できない論文は評価スコア0となります
- **レート制限**: PubMed APIのレート制限により、処理速度が制限されます

## 🐛 トラブルシューティング

### API Keyエラー

```
Error: Gemini API key is required
```

→ .envファイルまたはGUIでAPI Keyを設定してください

### PMID抽出エラー

```
Error: Invalid PMID or URL
```

→ 正しいPubMed IDまたはURLを入力してください

### 論文取得失敗

```
Failed to fetch article
```

→ PMIDが存在するか、PubMed APIが正常に動作しているか確認してください

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🙏 謝辞

- [PubMed E-utilities API](https://www.ncbi.nlm.nih.gov/books/NBK25501/)
- [Google Gemini API](https://ai.google.dev/)
- [Streamlit](https://streamlit.io/)

## 📧 お問い合わせ

バグ報告や機能要望は、GitHubのIssueまでお願いします。
